# Helm Package for pilcrow

Pilcrow is a web application designed to support the Collaborative Community Review (CCR) peer-review process.

Collaborative Community Review is a healthier, more effective way to review and develop work for publication.

## TL;DR

```console
helm install my-release oci://ghcr.io/mesh-research/pilcrow/helm
```
> [!CAUTION]
> By default, this chart uses subcharts to deploy MySQL and Redis alongside the application.  This is likely NOT what you want for a production deployment.

## Introduction
This chart bootstraps a Pilcrow Application deployment using Helm.

## Prerequisties

- Kubernetes 1.23+
- Helm 3.8.0+

## Optional Dependencies
The chart includes subcharts for some services.

- MySQL 8.4+
- Redis 8.0+

## Installing the chart

To install the chart with the release name `my-release`:

```console
helm install my-release oci://ghcr.io/mesh-research/pilcrow/helm
```

These commands deploy Pilcrow on the Kubernetes cluster in the default configuration. The [Parameters](#parameters) section lists the parameters that can be configured during installation.

## Configuration and Installation details

### Documentation
Installation and configuration items that aren't specific to Helm can be found n the [Pilcrow Documentation](https://latest.docs.pilcrow.dev/install)

### Resource requests and limits
Resource limits can be configured for each container inside the deployment. Settings requests is essential for prouction workloads and these should be adapted to your specific needs.  Find more information on container resource
management in the [official Kubernetes documentation](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/)

### Use a different Pilcrow version

To modify the application version used in this chart, specify a different version of the image using the `image.tag` parameter and/or a different repository using the `image.repository` parameter.

### Ingress

> [!NOTE]
> Pilcrow can currently only be hosted on the root of a domain (/) on a single hostname.  Create the ingress manually to allow more customization.

This chart provides support for Ingress resources. If you have an ingress controller installed on your cluster, such as [nginx-ingress-controller](https://github.com/bitnami/charts/tree/main/bitnami/nginx-ingress-controller) or [contour](https://github.com/bitnami/charts/tree/main/bitnami/contour) you can utilize the ingress controller to serve your application.To enable Ingress integration, set `ingress.enabled` to `true`.

The `ingress.hostname` property can be used to set the host name. The `ingress.tls` parameter can be used to add the TLS configuration for this host.

Adding the TLS parameter (where available) will cause the chart to generate HTTPS URLs, and the  application will be available on port 443. The actual TLS secrets do not have to be generated by this chart. However, if TLS is enabled, the Ingress record will not work until the TLS secret exists.

[Learn more about Ingress controllers](https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/).

### Securing traffic using TLS

> [!IMPORTANT]
> Modern browsers require TLS/SSL for many of the browser API's that Pilcrow uses.  While the chart or application doesn't **require** TLS/SSL, it should be considered required for a production deployment.

This chart facilitates the creation of TLS secrets for use with the Ingress controller (although this is not mandatory). There are several common use cases:

- Enable externally generated certificates.
- Manage application certificates via an external service (like [cert-manager](https://github.com/jetstack/cert-manager/)).

Here is an example of a certificate file:

> NOTE: There may be more than one certificate if there is a certificate chain.

```text
-----BEGIN CERTIFICATE-----
MIID6TCCAtGgAwIBAgIJAIaCwivkeB5EMA0GCSqGSIb3DQEBCwUAMFYxCzAJBgNV
...
jScrvkiBO65F46KioCL9h5tDvomdU1aqpI/CBzhvZn1c0ZTf87tGQR8NK7v7
-----END CERTIFICATE-----
```

Here is an example of a certificate key:

```text
-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAvLYcyu8f3skuRyUgeeNpeDvYBCDcgq+LsWap6zbX5f8oLqp4
...
wrj2wDbCDCFmfqnSJ+dKI3vFLlEz44sAV8jX/kd4Y6ZTQhlLbYc=
-----END RSA PRIVATE KEY-----
```

- If managing TLS secrets separately, it is necessary to create a TLS secret with name `INGRESS_HOSTNAME-tls` (where INGRESS_HOSTNAME is a placeholder to be replaced with the hostname you set using the `*.ingress.hostname` parameter).
- If your cluster has a [cert-manager](https://github.com/jetstack/cert-manager) add-on to automate the management and issuance of TLS certificates, add to `*.ingress.annotations` the [corresponding ones](https://cert-manager.io/docs/usage/ingress/#supported-annotations) for cert-manager.

## Parameters

### Application Configuration

The `pilcrow.appKey` is used to sign cookies and other data.  It will be generated if not set in
the values file.  Be sure to save the key if you generate it, as it will be needed to
decrypt existing data.
In production, it is recommended to generate your own appKey and save it in a secret:
```yaml
secret: {name: my-app-key-secret, key: app-key}
```

| Name                    | Description                                                                           | Value                   |
| ----------------------- | ------------------------------------------------------------------------------------- | ----------------------- |
| `pilcrow.appUrl`        | The base URL for the application. (required)                                          | `http://localhost:8888` |
| `pilcrow.appKey.value`  | The key used to sign cookies and other data. Will be generated if not set.            | `nil`                   |
| `pilcrow.appKey.secret` | The secret which contains the app key. `appKey.value` will be ignored if this is set. | `nil`                   |
| `pilcrow.cdn.enabled`   | Enable CDN support.                                                                   | `false`                 |
| `pilcrow.cdn.baseUrl`   | The base URL for the CDN. This is used to serve static assets.                        | `nil`                   |

### Database Configuration

NOTE: This section is required if disabling the MySQL subchart.
When supplying the MySQL password, placing the password in a secret is recommended rather
than hardcoding it in the values file.
```yaml
secret: { name: my-password-secret, key: password }
```

| Name                     | Description                                                                    | Value  |
| ------------------------ | ------------------------------------------------------------------------------ | ------ |
| `pilcrow.mysql.host`     | The hostname or IP address of the MySQL server.                                | `""`   |
| `pilcrow.mysql.port`     | The port of the MySQL server.                                                  | `3306` |
| `pilcrow.mysql.database` | The name of the MySQL database to use.                                         | `""`   |
| `pilcrow.mysql.user`     | The username to use for the MySQL connection.                                  | `""`   |
| `pilcrow.mysql.password` | The password to use for the MySQL connection.                                  | `""`   |
| `pilcrow.mysql.secret`   | The details of the secret containing the MySQL credentials. (ignores password) | `{}`   |

### Redis Configuration

NOTE: This section is required if disabling the Redis subchart.
When supplying the Redis password, placing the password in a secret is recommended rather
than hardcoding it in the values file.
```yaml
secret: { name: my-redis-password-secret, key: password }
```

| Name                     | Description                                                                    | Value  |
| ------------------------ | ------------------------------------------------------------------------------ | ------ |
| `pilcrow.redis.host`     | The hostname or IP address of the Redis server.                                | `""`   |
| `pilcrow.redis.port`     | The port of the Redis server.                                                  | `6379` |
| `pilcrow.redis.password` | The password to use for the Redis connection.                                  | `""`   |
| `pilcrow.redis.secret`   | The details of the secret containing the Redis credentials. (ignores password) | `{}`   |

### Advanced Configuration

The values in this section have sensible defaults and probably shouldn't need to be
changed in most cases.

| Name                       | Description                                                                                                                      | Value    |
| -------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | -------- |
| `pilcrow.logChannel`       | The log channel to use for the application.                                                                                      | `stderr` |
| `pilcrow.sessionDriver`    | The session driver to use for the application.                                                                                   | `redis`  |
| `pilcrow.cacheDriver`      | The cache driver to use for the application.                                                                                     | `redis`  |
| `ingress.enabled`          | Enable the ingress resource.                                                                                                     | `false`  |
| `ingress.ingressClassName` | The name of the ingress class to use.                                                                                            | `nil`    |
| `ingress.hostname`         | The hostname to use for the ingress resource.                                                                                    | `nil`    |
| `ingress.tls`              | Enable TLS configuration for the host defined at `ingress.hostname` parameter                                                    | `false`  |
| `ingress.annotations`      | Additional annotations for the Ingress resource. To enable certificate autogeneration, place here your cert-manager annotations. | `{}`     |

### MySQL Subchart

Not recommended for production use--use an external MySQL server instead.

| Name                           | Description                                    | Value     |
| ------------------------------ | ---------------------------------------------- | --------- |
| `mysql.enabled`                | Deploy the MySQL subchart if true.             | `true`    |
| `mysql.auth.database`          | The name of the database to create.            | `pilcrow` |
| `mysql.primary.resourcePreset` | The resource preset for the MySQL primary pod. | `nano`    |

### Redis Subchart

Not recommended for production use--use an external Redis server instead.

| Name            | Description                        | Value  |
| --------------- | ---------------------------------- | ------ |
| `redis.enabled` | Deploy the Redis subchart if true. | `true` |

### Deployment

| Name                                     | Description                                                                     | Value                               |
| ---------------------------------------- | ------------------------------------------------------------------------------- | ----------------------------------- |
| `service.type`                           | The type of service to create. (ClusterIP, NodePort, LoadBalancer)              | `ClusterIP`                         |
| `replicaCount`                           | The number of replicas to deploy.                                               | `1`                                 |
| `image.webRepository`                    | The repository for the web image.                                               | `ghcr.io/mesh-research/pilcrow/web` |
| `image.fpmRepository`                    | The repository for the FPM image.                                               | `ghcr.io/mesh-research/pilcrow/fpm` |
| `image.pullPolicy`                       | The pull policy for the images.                                                 | `IfNotPresent`                      |
| `image.tag`                              | The tag for the images. Defaults to the chart appVersion.                       | `""`                                |
| `imagePullSecrets`                       | Image pull secrets for the images.                                              | `[]`                                |
| `web.securityContext`                    | Security context for the web container.                                         | `{}`                                |
| `web.extraVolumeMounts`                  | Additional volume mounts for the web container.                                 | `[]`                                |
| `web.resources`                          | Resource requests and limits for the web container.                             | `{}`                                |
| `web.livenessProbe.enabled`              | Enable liveness probe for the web container.                                    | `true`                              |
| `web.livenessProbe.initialDelaySeconds`  | The number of seconds to wait before starting the liveness probe.               | `5`                                 |
| `web.livenessProbe.periodSeconds`        | The number of seconds between liveness probes.                                  | `10`                                |
| `web.livenessProbe.timeoutSeconds`       | The number of seconds to wait for a response from the liveness probe.           | `5`                                 |
| `web.livenessProbe.failureThreshold`     | The number of consecutive failures before the container is restarted.           | `6`                                 |
| `web.livenessProbe.successThreshold`     | The number of consecutive successes before the container is considered healthy. | `1`                                 |
| `web.readinessProbe.enabled`             | Enable liveness probe for the web container.                                    | `true`                              |
| `web.readinessProbe.initialDelaySeconds` | The number of seconds to wait before starting the liveness probe.               | `5`                                 |
| `web.readinessProbe.periodSeconds`       | The number of seconds between liveness probes.                                  | `10`                                |
| `web.readinessProbe.timeoutSeconds`      | The number of seconds to wait for a response from the liveness probe.           | `5`                                 |
| `web.readinessProbe.failureThreshold`    | The number of consecutive failures before the container is restarted.           | `6`                                 |
| `web.readinessProbe.successThreshold`    | The number of consecutive successes before the container is considered healthy. | `1`                                 |
| `fpm.extraVolumeMounts`                  | Additional volume mounts for the FPM container.                                 | `[]`                                |
| `fpm.securityContext`                    | Security context for the FPM container.                                         | `{}`                                |
| `fpm.resources`                          | Resource requests and limits for the FPM container.                             | `{}`                                |
| `fpm.livenessProbe.enabled`              | Enable liveness probe for the fpm container.                                    | `true`                              |
| `fpm.livenessProbe.initialDelaySeconds`  | The number of seconds to wait before starting the liveness probe.               | `5`                                 |
| `fpm.livenessProbe.periodSeconds`        | The number of seconds between liveness probes.                                  | `10`                                |
| `fpm.livenessProbe.timeoutSeconds`       | The number of seconds to wait for a response from the liveness probe.           | `5`                                 |
| `fpm.livenessProbe.failureThreshold`     | The number of consecutive failures before the container is restarted.           | `6`                                 |
| `fpm.livenessProbe.successThreshold`     | The number of consecutive successes before the container is considered healthy. | `1`                                 |
| `fpm.readinessProbe.enabled`             | Enable liveness probe for the fpm container.                                    | `true`                              |
| `fpm.readinessProbe.initialDelaySeconds` | The number of seconds to wait before starting the liveness probe.               | `5`                                 |
| `fpm.readinessProbe.periodSeconds`       | The number of seconds between liveness probes.                                  | `10`                                |
| `fpm.readinessProbe.timeoutSeconds`      | The number of seconds to wait for a response from the liveness probe.           | `5`                                 |
| `fpm.readinessProbe.failureThreshold`    | The number of consecutive failures before the container is restarted.           | `6`                                 |
| `fpm.readinessProbe.successThreshold`    | The number of consecutive successes before the container is considered healthy. | `1`                                 |
| `serviceAccount.create`                  | Whether to create a service account for the deployment.                         | `true`                              |
| `serviceAccount.automount`               | Whether to automatically mount the service account's API credentials.           | `true`                              |
| `serviceAccount.annotations`             | Annotations to add to the service account.                                      | `{}`                                |
| `serviceAccount.name`                    | The name of the service account to use.                                         | `""`                                |

### Global Configuration

| Name                 | Description                             | Value |
| -------------------- | --------------------------------------- | ----- |
| `extraVolumes`       | Additional volumes to mount in the pod. | `[]`  |
| `nodeSelector`       | Node selector for the pod.              | `{}`  |
| `tolerations`        | Tolerations for the pod.                | `[]`  |
| `affinity`           | Affinity rules for the pod.             | `{}`  |
| `podAnnotations`     | Annotations to add to the pod.          | `{}`  |
| `podLabels`          | Additional labels to add to the pod.    | `{}`  |
| `podSecurityContext` | Security context for the pod.           | `{}`  |
